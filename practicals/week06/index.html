Last Updated on 2023/03/27      

<?xml version="1.0" encoding="iso-8859-1" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">  
<!--http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd-->  
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head> <title>Scaling Stateless Components</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
<meta name="generator" content="TeX4ht (https://tug.org/tex4ht/)" /> 
<meta name="originator" content="TeX4ht (https://tug.org/tex4ht/)" /> 
<!-- fn-in,html,htex4ht,xhtml --> 
<meta name="src" content="main.tex" /> 
<link rel="stylesheet" type="text/css" href="main.css" /> 
<link rel="stylesheet" href="https://latex.now.sh/style.css"> 
<link rel="stylesheet" href="/notes.css"> 
<style>body {max-width: 100ch;} 
dl dd {text-align: left}</style> 
</head><body 
>
   <div class="maketitle"><a 
 id="Q1-1-1"></a>
_________________________________________________________________________________________________
<h2 class="titleHead">Scaling Stateless Components</h2>                                                  Software Architecture
   <div class="date" >March 29, 2023</div>                                                                                 <div class="author" >Evan Hughes &amp; Anna Truffet &amp; Brae Webb
</div>
____________________________________________________________________________________________________
   </div>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 18--><p class="noindent" >
</p><!--l. 19--><p class="noindent" ><img 
src="images/scaling-out.png" alt="PIC"  
width="28" height="28"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
   <h3 class="sectionHead"><span class="titlemark">1    </span> <a 
 id="x1-10001"></a>This Week</h3>
<!--l. 24--><p class="noindent" >Our goal is to scale out the stateless component of our TaskOverflow application across multiple compute
instances. Specifically we will need to: </p>
      <ul class="itemize1">
      <li class="itemize">
      <!--l. 27--><p class="noindent" >Route traffic to our deployed TaskOverflow application with a load balancer.
      </p></li>
      <li class="itemize">
      <!--l. 28--><p class="noindent" >Scale out TaskOverflow instances with autoscaling.
      </p></li>
      <li class="itemize">
      <!--l. 29--><p class="noindent" >Check the status of our instances with a healthcheck.
      </p></li>
      <li class="itemize">
      <!--l. 30--><p class="noindent" >Dynamically scale our application based on load.</p></li></ul>
<!--l. 33--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">2    </span> <a 
 id="x1-20002"></a>Load Balancers</h3>
<!--l. 35--><p class="noindent" >Load balancing distributes a load over a set of resources. For example, balacing network traffic across several
servers. Load balancing is crucial to the scalability of modern systems, as often, one physical device can not
process the large amount network traffic for (e.g.) a large website.
</p><!--l. 39--><p class="indent" >   A service which load balances, is called a <span 
class="Cabin-Bold-tlf-t1-x-x-120">Load Balancer</span>.
</p><!--l. 42--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">2.1    </span> <a 
 id="x1-30002.1"></a>Routing Algorithms</h4>
<!--l. 44--><p class="noindent" >A load balancer can implement many techinques to select which resource to route incoming requests toward,
these techniques are the load balancer&#8217;s routing algorithm.
</p><!--l. 46--><p class="indent" >   Below lists several common routing techniques. There are many other generic and bespoke routing algorithms
that are not listed.
</p><!--l. 49--><p class="indent" >
      </p><dl class="description"><dt class="description">
      <!--l. 50--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Round Robin</span> </p></dt><dd 
class="description">
      <!--l. 50--><p class="noindent" >allocates requests to the next available server regardless of where the last request was sent. It is
      simple, and in practice, works effectively.
                                                                                                    
                                                                                                    
      </p></dd><dt class="description">
      <!--l. 52--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Least Connections</span> </p></dt><dd 
class="description">
      <!--l. 52--><p class="noindent" >sends  the  next  request  to  the  node  with  the  fewest  current  connections.  The  load  balancer  is
      responsible for tracking how many connections exist to each node.
      </p></dd><dt class="description">
      <!--l. 54--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Weighted Least Connections</span> </p></dt><dd 
class="description">
      <!--l. 54--><p class="noindent" >sends the next request to the node with the least weighted connections. This is similar to the above
      least connections method, however, each node has an associated weight. This allows certain nodes
      to be preferred over others. This is useful if we have an inequal distribution of compute power. We
      would want to give smaller nodes a reduced load in comparison to other more powerful nodes.
      </p></dd><dt class="description">
      <!--l. 58--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Consistent Hashing</span> </p></dt><dd 
class="description">
      <!--l. 58--><p class="noindent" >In some cases we may want a user to consistently be routed to a specific node. This is useful for
      multiple transactions that need to be done in a consistent order or if the data is stored/cached on
      the node. This can be done by hashing the information in the request payload or headers and then
      routing the request to the node that handles hashes in the range of the computed hash.</p></dd></dl>
<!--l. 63--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">2.2    </span> <a 
 id="x1-40002.2"></a>Health Checks</h4>
<!--l. 65--><p class="noindent" >When load balancing, it is important to ensure that the nodes we route requests to are able to service the request.
A good health check can save or break your service. Consider the two following examples from UQ&#8217;s Information
Technology Services (ITS):
</p>
<!--l. 69--><p class="noindent" ><span class="paragraphHead"><a 
 id="x1-5000"></a><span 
class="Cabin-Bold-tlf-t1-x-x-120">Example 1</span></span>
   Early in my career, I, Evan Hughes, setup a multi-node Directory Server at UQ under the hostname of
<span 
class="ectt-1200">ldap.uq.edu.au</span>. This server was a NoSQL database which implemented the LDAP protocol and supported <span 
class="ectt-1200">UQ</span>
<span 
class="ectt-1200">Authenticate</span>, UQ&#8217;s Single Sign-On service.
</p><!--l. 73--><p class="indent" >   The service had a load balancer which checked that <span 
class="ectt-1200">port 389 </span>is open and reachable. This worked well most of
the time. However, the health check was too weak. When:
      </p><ol  class="enumerate1" >
<li 
  class="enumerate" id="x1-5002x1">
      <!--l. 77--><p class="noindent" >A data-center outage occured; and
      </p></li>
<li 
  class="enumerate" id="x1-5004x2">
      <!--l. 78--><p class="noindent" >The operating system running the service disappeared; but
                                                                                                    
                                                                                                    
      </p></li>
<li 
  class="enumerate" id="x1-5006x3">
      <!--l. 79--><p class="noindent" >The service was still running in memory.</p></li></ol>
<!--l. 82--><p class="indent" >   The health check passed, but in reality, the service was talking to dead nodes, causing upstream services to
have intermitent failures.
</p>
   <div class="tcolorbox tcolorbox" id="tcolobox-1">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 84--><p class="noindent" >TODO: C4 Diagram of the architecture </p> 
</div> 
</div>
<!--l. 86--><p class="noindent" ><span class="paragraphHead"><a 
 id="x1-6000"></a><span 
class="Cabin-Bold-tlf-t1-x-x-120">Example 2</span></span>
   During the rollout of a new prompt for UQ Authenticate which required users to go to my.UQ to provide
verified contact details - the Blackboard (learn.uq.edu.au) service went completly offline. The health check for
Blackboard at the time completed a full authentication as a test user to ensure everything was functioning as
expected. Once this user was enrolled into the new rollout, the health checks started reporting failures and within
a matter of minutes the entire pool of nodes were shutdown. This health check was too broad and was not
isolated enough to the service that it was checking.
</p>
   <div class="tcolorbox tcolorbox" id="tcolobox-2">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 92--><p class="noindent" >TODO: C4 diagram of the architecture </p> 
</div> 
</div>
<!--l. 94--><p class="indent" >   A lot of services will provide a health check endpoint or a metrics endpoint which can help the engineer setup
a proper level of health check. We want a health check that is specific enough for the service that it is checking but
not so specific that it is too brittle. For the TaskOverflow application that we have been building so far, a
reasonable health check would be that the health endpoint ensures the database is available and that the
application is able to connect to it.
</p><!--l. 99--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">3    </span> <a 
 id="x1-70003"></a>Load Balancers in AWS</h3>
<!--l. 101--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.1    </span> <a 
 id="x1-80003.1"></a>Types of AWS Load Balancers</h4>
<!--l. 102--><p class="noindent" >Not all load balancers are the same. Some load balancers inspect the transmitted packets to correctly route the
packet. We will cover two load balancer types AWS provides:
</p><!--l. 106--><p class="indent" >
      </p><dl class="description"><dt class="description">
      <!--l. 107--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Application Load Balancer</span> </p></dt><dd 
class="description">
      <!--l. 107--><p class="noindent" >is an OSI layer 7<span class="footnote-mark"><a 
href="#fn1x0" id="fn1x0-bk"><sup class="textsuperscript">1</sup></a></span><a 
 id="x1-8001f1"></a>
      load balancer which routes traffic based on the request&#8217;s content. This is useful for services using
      HTTP, HTTPS, or any other supported protocol.
                                                                                                    
                                                                                                    
      </p></dd><dt class="description">
      <!--l. 111--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Network Load Balancer</span> </p></dt><dd 
class="description">
      <!--l. 111--><p class="noindent" >is an OSI layer 4<span class="footnote-mark"><a 
href="#fn2x0" id="fn2x0-bk"><sup class="textsuperscript">2</sup></a></span><a 
 id="x1-8003f2"></a>
      load balancer which routes traffic based on the source and destination IP addresses and ports. This
      is useful for services that are using TCP or UDP.</p></dd></dl>
<!--l. 117--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.2    </span> <a 
 id="x1-90003.2"></a>AWS Load Balancer Design</h4>
<!--l. 119--><p class="noindent" >An AWS Elastic Load Balancer has three distinct components.
</p><!--l. 121--><p class="indent" >
      </p><dl class="description"><dt class="description">
      <!--l. 122--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Listeners</span> </p></dt><dd 
class="description">
      <!--l. 122--><p class="noindent" >allows traffic to enter the Elastic Load Balancer. Each listener has a port (e.g. <span 
class="ectt-1200">port 80</span>) and a protocol
      (e.g. <span 
class="ectt-1200">HTTP</span>) associated with it.
      </p></dd><dt class="description">
      <!--l. 124--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Target Groups</span> </p></dt><dd 
class="description">
      <!--l. 124--><p class="noindent" >are groups of nodes which the load balancer can route to. Each target group has a protocol and a
      port associated with it, allowing us (the programmer) to switch ports on the way through the load
      balancer. This is useful if the targets are using a different port to the ports we want to expose.
      </p></dd><dt class="description">
      <!--l. 127--><p class="noindent" >
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Load Balancer</span> </p></dt><dd 
class="description">
      <!--l. 127--><p class="noindent" >is the actual load balancer that routes the traffic to the target groups based on rules that we setup.
      The load balancer has a DNS name that we can use to route traffic to it. The load balancer also has
      a security group that we can use to control what traffic can enter the load balancer.</p></dd></dl>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<!--l. 133--><p class="noindent" ><img 
src="diagrams/loadbalancers.png" alt="PIC"  
width="525" height="525"  />
                                                                                                    
                                                                                                    
</p>
   </div><hr class="endfigure" />
   <h4 class="subsectionHead"><span class="titlemark">3.3    </span> <a 
 id="x1-100003.3"></a>Autoscaling in AWS</h4>
<!--l. 137--><p class="noindent" >Instead of creating the maxiumum amount of services we predict we will need, we can automatically scale the
number of nodes we need to minimise resources. When the load is low, we operate with minimal nodes. When
the load is high, we increase the number of nodes available to cope.
</p><!--l. 142--><p class="indent" >   To compute the resources needed, AWS relies on triggers from CloudWatch and scaling policies. Some
premade triggers are based around a node&#8217;s;
</p>
      <ul class="itemize1">
      <li class="itemize">
      <!--l. 146--><p class="noindent" >CPU usage,
      </p></li>
      <li class="itemize">
      <!--l. 147--><p class="noindent" >memory usage, or
      </p></li>
      <li class="itemize">
      <!--l. 148--><p class="noindent" >network usage.</p></li></ul>
<!--l. 151--><p class="indent" >   We create custom triggers based on our application&#8217;s metrics.
</p><!--l. 153--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">4    </span> <a 
 id="x1-110004"></a>Load Balancing TaskOverflow</h3>
<!--l. 155--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.1    </span> <a 
 id="x1-120004.1"></a>[Path A] EC2</h4>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<!--l. 158--><p class="noindent" ><img 
src="diagrams/ec2deployment.png" alt="PIC"  
width="525" height="525"  />
                                                                                                    
                                                                                                    
</p>
   </div><hr class="endfigure" />
   <div class="tcolorbox tcolorbox" id="tcolobox-3">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 161--><p class="noindent" >TODO: Move to EC2Template </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-4">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 163--><p class="noindent" >TODO: AutoScaling group </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-5">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 165--><p class="noindent" >TODO: target group </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-6">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 167--><p class="noindent" >TODO: autoscaling + target </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-7">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 169--><p class="noindent" >TODO: load balancer </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-8">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 171--><p class="noindent" >TODO: listener </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-9">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 173--><p class="noindent" >TODO: Applying autoscaling rules </p> 
</div> 
</div>
   <h4 class="subsectionHead"><span class="titlemark">4.2    </span> <a 
 id="x1-130004.2"></a>[Path B] ECS</h4>
   <div class="tcolorbox tcolorbox" id="tcolobox-10">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 177--><p class="noindent" >TODO: load balancer </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-11">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 179--><p class="noindent" >TODO: adding to ecs </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-12">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 181--><p class="noindent" >TODO: listener </p> 
</div> 
</div>
   <div class="tcolorbox tcolorbox" id="tcolobox-13">    
<div class="tcolorbox-title">
   </div> 
<div class="tcolorbox-content"><!--l. 183--><p class="noindent" >TODO: Applying autoscaling rules </p> 
</div> 
</div>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<!--l. 186--><p class="noindent" ><img 
src="diagrams/ecsdeployment.png" alt="PIC"  
width="525" height="525"  />
                                                                                                    
                                                                                                    
</p>
   </div><hr class="endfigure" />
   <h4 class="subsectionHead"><span class="titlemark">4.3    </span> <a 
 id="x1-140004.3"></a>Producing Load with K6</h4>
<!--l. 1--><p class="noindent" >
</p>
   <h3 class="likesectionHead"><a 
 id="x1-15000"></a>References</h3>
<!--l. 1--><p class="noindent" >
</p>
   <div class="footnotes"><a 
 id="x1-8002x3.1"></a>
<!--l. 108--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn1x0-bk" id="fn1x0"><sup class="textsuperscript">1</sup></a></span><span 
class="Cabin-Regular-tlf-t1-">OSI layer 7: Application, in this case HTTP/HTTPS/etc</span></p><a 
 id="x1-8004x3.1"></a>
<!--l. 112--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn2x0-bk" id="fn2x0"><sup class="textsuperscript">2</sup></a></span><span 
class="Cabin-Regular-tlf-t1-">OSI layer 4: Transport, in this case TCP/UDP</span></p>                                                                                                                                                </div>
 
</body></html> 

                                                                                                    


