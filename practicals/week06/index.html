Last Updated on 2023/03/28
                                                                                                    

<?xml version="1.0" encoding="iso-8859-1" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">  
<!--http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd-->  
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head> <title>Scaling Stateless Components</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
<meta name="generator" content="TeX4ht (https://tug.org/tex4ht/)" /> 
<meta name="originator" content="TeX4ht (https://tug.org/tex4ht/)" /> 
<!-- fn-in,html,htex4ht,xhtml --> 
<meta name="src" content="main.tex" /> 
<link rel="stylesheet" type="text/css" href="main.css" /> 
<link rel="stylesheet" href="https://latex.now.sh/style.css"> 
<link rel="stylesheet" href="/notes.css"> 
<style>body {max-width: 100ch;} 
dl dd {text-align: left}</style> 
</head><body 
>
   <div class="maketitle"><a 
 id="Q1-1-1"></a>
_________________________________________________________________________________________________
<h2 class="titleHead">Scaling Stateless Components</h2>                                                  Software Architecture
   <div class="date" >March 27, 2024</div>                                                                                 <div class="author" >Evan Hughes &amp; Anna Truffet &amp; Brae Webb
</div>
____________________________________________________________________________________________________
   </div>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 18--><p class="noindent" >
</p><!--l. 19--><p class="noindent" ><img 
src="images/scaling-out.png" alt="PIC"  
width="28" height="28"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
   <h3 class="sectionHead"><span class="titlemark">1    </span> <a 
 id="x1-10001"></a>This Week</h3>
<!--l. 24--><p class="noindent" >Our goal is to scale out the stateless component of our TaskOverflow application across multiple compute
instances. Specifically we will need to: </p>
      <ul class="itemize1">
      <li class="itemize">
      <!--l. 27--><p class="noindent" >Route traffic to our deployed TaskOverflow application with a <span 
class="Cabin-Italic-tlf-t1-x-x-120">load balancer</span>.
      </p></li>
      <li class="itemize">
      <!--l. 28--><p class="noindent" >Scale out TaskOverflow instances with <span 
class="Cabin-Italic-tlf-t1-x-x-120">autoscaling</span>.
      </p></li>
      <li class="itemize">
      <!--l. 29--><p class="noindent" >Check the status of our instances with a <span 
class="Cabin-Italic-tlf-t1-x-x-120">healthcheck</span>.
      </p></li>
      <li class="itemize">
      <!--l. 30--><p class="noindent" ><span 
class="Cabin-Italic-tlf-t1-x-x-120">Dynamically scale </span>our application based on load.</p></li></ul>
<!--l. 33--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">2    </span> <a 
 id="x1-20002"></a>Load Balancers</h3>
<!--l. 35--><p class="noindent" >Load balancing distributes a load over a set of resources. For example, balancing network traffic across several
servers. Load balancing is crucial to the scalability of modern systems, as often, one physical device cannot
the volume of requests or the processing demand (e.g. the large amount network traffic for a large
website).
</p><!--l. 41--><p class="indent" >   A service which load balances, is called a <span 
class="Cabin-Bold-tlf-t1-x-x-120">Load Balancer</span>.
</p><!--l. 44--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">2.1    </span> <a 
 id="x1-30002.1"></a>Routing Algorithms</h4>
<!--l. 46--><p class="noindent" >A load balancer can implement many techniques to select which resource to route incoming requests toward,
these techniques are the load balancer&#8217;s routing algorithm.
</p><!--l. 49--><p class="indent" >   Below are several common routing techniques. There are many other generic and bespoke routing algorithms
that are not listed.
</p><!--l. 52--><p class="indent" >
      </p><dl class="description"><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Round Robin</span> </dt><dd 
class="description">
      <!--l. 53--><p class="noindent" >allocates requests to the next available server regardless of where the last request was sent. It is
      simple, and in practice, works effectively.
                                                                                                    
                                                                                                    
      </p></dd><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Least Connections</span> </dt><dd 
class="description">
      <!--l. 55--><p class="noindent" >sends  the  next  request  to  the  node  with  the  fewest  current  connections.  The  load  balancer  is
      responsible for tracking how many connections exist to each node.
      </p></dd><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Weighted Least Connections</span> </dt><dd 
class="description">
      <!--l. 57--><p class="noindent" >sends the next request to the node with the least weighted connections. This is similar to the above
      least connections method, however, each node has an associated weight. This allows certain nodes
      to be preferred over others. This is useful if we have an inequal distribution of compute power. We
      would want to give smaller nodes a reduced load in comparison to other more powerful nodes.
      </p></dd><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Consistent Hashing</span> </dt><dd 
class="description">
      <!--l. 61--><p class="noindent" >In some cases we may want a user to consistently be routed to a specific node. This is useful for
      multiple transactions that need to be done in a consistent order or if the data is stored/cached on
      the node. This can be done by hashing the information in the request payload or headers and then
      routing the request to the node that handles hashes in the range of the computed hash.</p></dd></dl>
<!--l. 66--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">2.2    </span> <a 
 id="x1-40002.2"></a>Health Checks</h4>
<!--l. 68--><p class="noindent" >When load balancing, it is important to ensure that the nodes to which we route requests are able to service the
request. A good health check can save or break your service. Consider the two following examples from UQ&#8217;s
Information Technology Services (ITS):
</p>
<!--l. 72--><p class="noindent" ><span class="paragraphHead"><a 
 id="x1-5000"></a><span 
class="Cabin-Bold-tlf-t1-x-x-120">Example 1</span></span>
   Early in my career, I, Evan Hughes, setup a multi-node Directory Server at UQ under the hostname of
<span 
class="ectt-1200">ldap.uq.edu.au</span>. This server was a NoSQL database which implemented the LDAP protocol and supported <span 
class="ectt-1200">UQ</span>
<span 
class="ectt-1200">Authenticate</span>, UQ&#8217;s Single Sign-On service.
</p><!--l. 76--><p class="indent" >   The service had a load balancer which checked that <span 
class="ectt-1200">port 389 </span>was open and reachable. This worked well most
of the time. However, the health check was too weak. When
      </p><ol  class="enumerate1" >
<li 
  class="enumerate" id="x1-5002x1">
      <!--l. 80--><p class="noindent" >a data-center outage occurred; and
      </p></li>
<li 
  class="enumerate" id="x1-5004x2">
      <!--l. 81--><p class="noindent" >the storage running the service disappeared; but
      </p></li>
<li 
  class="enumerate" id="x1-5006x3">
      <!--l. 82--><p class="noindent" >the service was still running in memory.</p></li></ol>
                                                                                                    
                                                                                                    
<!--l. 85--><p class="indent" >   The health check passed, but in reality, the service was talking to dead nodes, causing upstream services to
have intermittent failures.
</p>
<!--l. 87--><p class="noindent" ><span class="paragraphHead"><a 
 id="x1-6000"></a><span 
class="Cabin-Bold-tlf-t1-x-x-120">Example 2</span></span>
   During the rollout of a new prompt for UQ Authenticate, which required users to go to my.UQ to provide
verified contact details &#8211; the Blackboard (learn.uq.edu.au) service went completely offline. The health check for
Blackboard at the time completed a full authentication as a test user to ensure everything was functioning as
expected. Once this user was enrolled into the new rollout, the health checks started reporting failures and within
a matter of minutes the entire pool of nodes were shutdown. This health check was too broad and was not
isolated enough to the service that it was checking.
</p><!--l. 94--><p class="indent" >   A lot of services will provide a health check endpoint or a metrics endpoint which can help the engineer setup
a proper level of health check. We want a health check that is specific enough for the service that it is checking but
not so specific that it is too brittle. For the TaskOverflow application that we have been building so far, a
reasonable health check would be that the health endpoint ensures the database is available and that the
application is able to connect to it.
</p><!--l. 99--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">3    </span> <a 
 id="x1-70003"></a>Load Balancers in AWS</h3>
<!--l. 101--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.1    </span> <a 
 id="x1-80003.1"></a>Types of AWS Load Balancers</h4>
<!--l. 102--><p class="noindent" >Not all load balancers are the same. Some load balancers inspect the transmitted packets to correctly route the
packet. We will cover two types of load balancers provided by AWS:
</p><!--l. 106--><p class="indent" >
      </p><dl class="description"><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Application Load Balancer</span> </dt><dd 
class="description">
      <!--l. 107--><p class="noindent" >is an OSI layer 7<span class="footnote-mark"><a 
href="#fn1x0" id="fn1x0-bk"><sup class="textsuperscript">1</sup></a></span><a 
 id="x1-8001f1"></a>
      load balancer which routes traffic based on the request&#8217;s content. This is useful for services using
      HTTP, HTTPS, or any other supported protocol.
      </p></dd><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Network Load Balancer</span> </dt><dd 
class="description">
      <!--l. 111--><p class="noindent" >is an OSI layer 4<span class="footnote-mark"><a 
href="#fn2x0" id="fn2x0-bk"><sup class="textsuperscript">2</sup></a></span><a 
 id="x1-8003f2"></a>
      load balancer which routes traffic based on the source and destination IP addresses and ports. This
      is useful for services that are using TCP or UDP.</p></dd></dl>
<!--l. 117--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.2    </span> <a 
 id="x1-90003.2"></a>AWS Load Balancer Design</h4>
                                                                                                    
                                                                                                    
<!--l. 119--><p class="noindent" >An AWS Elastic<span class="footnote-mark"><a 
href="#fn3x0" id="fn3x0-bk"><sup class="textsuperscript">3</sup></a></span><a 
 id="x1-9001f3"></a>
Load Balancer has three distinct components.
</p><!--l. 121--><p class="indent" >
      </p><dl class="description"><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Listeners</span> </dt><dd 
class="description">
      <!--l. 122--><p class="noindent" >allows traffic to enter the Elastic Load Balancer. Each listener has a port (e.g. <span 
class="ectt-1200">port 80</span>) and a protocol
      (e.g. <span 
class="ectt-1200">HTTP</span>) associated with it.
      </p></dd><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Target Groups</span> </dt><dd 
class="description">
      <!--l. 124--><p class="noindent" >are groups of nodes which the load balancer can route to. Each target group has a protocol and a
      port associated with it, allowing us (the programmer) to switch ports on the way through the load
      balancer. This is useful if the targets are using a different port to the ports we want to expose.
      </p></dd><dt class="description">
<span 
class="Cabin-Bold-tlf-t1-x-x-120">Load Balancer</span> </dt><dd 
class="description">
      <!--l. 127--><p class="noindent" >is the actual load balancer that routes the traffic to the target groups based on rules that we setup.
      The load balancer has a DNS name that we can use to route traffic to it. The load balancer also has
      a security group that we can use to control what traffic can enter the load balancer.</p></dd></dl>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<!--l. 133--><p class="noindent" ><img 
src="diagrams/loadbalancers.png" alt="PIC"  
width="525" height="525"  />
                                                                                                    
                                                                                                    
</p>
   </div><hr class="endfigure" />
   <h4 class="subsectionHead"><span class="titlemark">3.3    </span> <a 
 id="x1-100003.3"></a>Autoscaling in AWS</h4>
<!--l. 137--><p class="noindent" >Instead of creating the maxiumum amount of services we predict we will need, we can automatically scale the
number of nodes we need to minimise resources. When the load is low, we operate with minimal nodes. When
the load is high, we increase the number of nodes available to cope.
</p><!--l. 142--><p class="indent" >   To compute the resources needed, AWS relies on triggers from CloudWatch and scaling policies. Some
premade triggers are based around a node&#8217;s
</p>
      <ul class="itemize1">
      <li class="itemize">
      <!--l. 146--><p class="noindent" >CPU usage,
      </p></li>
      <li class="itemize">
      <!--l. 147--><p class="noindent" >memory usage, or
      </p></li>
      <li class="itemize">
      <!--l. 148--><p class="noindent" >network usage.</p></li></ul>
<!--l. 151--><p class="indent" >   We create custom triggers based on our application&#8217;s metrics.
</p><!--l. 153--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">4    </span> <a 
 id="x1-110004"></a>Load Balancing TaskOverflow</h3>
<!--l. 155--><p class="noindent" >This week we are going to explore load balancing the TaskOverflow service that we have been working with. The aim is
to have a service that, when given a lot of requests, will be able to scale out the web server instances to handle it.
This will not be a full solution to the scaling issue as our database is still a single node, but it will be a good
start.<span class="footnote-mark"><a 
href="#fn4x0" id="fn4x0-bk"><sup class="textsuperscript">4</sup></a></span><a 
 id="x1-11001f4"></a>
Other methods could also be employed to help deal with the load like caching but we will leave that for another
day.
</p>
<!--l. 165--><p class="noindent" ><span class="paragraphHead"><a 
 id="x1-12000"></a><span 
class="Cabin-Bold-tlf-t1-x-x-120">Getting Started</span></span>
      </p><ol  class="enumerate1" >
<li 
  class="enumerate" id="x1-12002x1">
      <!--l. 167--><p class="noindent" >Using the GitHub Classroom link for this practical provided by your tutor in Slack, create a repository
      to work within.
                                                                                                    
                                                                                                    
      </p></li>
<li 
  class="enumerate" id="x1-12004x2">
      <!--l. 169--><p class="noindent" >Install Terraform if not already installed, as it will be required again this week.
      </p></li>
<li 
  class="enumerate" id="x1-12006x3">
      <!--l. 170--><p class="noindent" >Start your learner lab and copy the AWS Learner Lab credentials into a credentials file in the root of
      the repository.
      </p></li>
<li 
  class="enumerate" id="x1-12008x4">
      <!--l. 171--><p class="noindent" >In the repository you will have a <span 
class="ectt-1200">given </span>folder with two subfolders. <span 
class="ectt-1200">ec2 </span>is the starter Terraform code
      for the EC2 path from last week. <span 
class="ectt-1200">ecs </span>is the starter Terraform code for the ECS path from last week.
      </p></li>
<li 
  class="enumerate" id="x1-12010x5">
      <!--l. 174--><p class="noindent" >Copy the contents of the folder into the root of the repository based on the path you wish to take.</p></li></ol>
<!--l. 177--><p class="indent" >   As per last week, we encourage that you take <span 
class="ectt-1200">Path B </span>first and then peruse <span 
class="ectt-1200">Path A</span>, if you have time. This week,
<span 
class="ectt-1200">Path A </span>offers an alternative method to autoscaling.
</p><!--l. 180--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.1    </span> <a 
 id="x1-130004.1"></a>[Path A] EC2</h4>
<!--l. 182--><p class="noindent" >Congratulations! You have chosen to go down the EC2 path. This week we need to create an AutoScaling Group
and a Load Balancer to handle the scaling of our service. Our goal is to implement the deployment diagram
below.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<!--l. 187--><p class="noindent" ><img 
src="diagrams/ec2deployment.png" alt="PIC"  
width="525" height="525"  />
                                                                                                    
                                                                                                    
</p>
   </div><hr class="endfigure" />
<!--l. 190--><p class="indent" >   To get started, we need to modify how we create our EC2 instances. Instead of manually deploying an instance
we are going to tell AWS how to deploy instances for us. We can do this by converting our EC2 instance into a
Launch Template. Our launch template is going to look very similar to the instance we had last week, with a few
variables changing. This includes that <span 
class="ectt-1200">user_data </span>must be stored as a base64 encoded string. Some of these
changes have been highlighted below.
</p><!--l. 197--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 197--><p class="indent" >   <span 
class="ectt-1200">» cat ec2.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 197--><pre class="listings" id="listing-1"><span class="label"><a 
 id="x1-13001r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_launch_template</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13002r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">-</span></span><span style="color:#669900"><span 
class="ectt-1200">launch</span></span><span style="color:#669900"><span 
class="ectt-1200">-</span></span><span style="color:#669900"><span 
class="ectt-1200">template</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13003r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span 
class="colorbox" id="colorbox1"><span 
class="ectt-1200">image_id</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">ami</span></span><span style="color:#669900"><span 
class="ectt-1200">-005</span></span><span style="color:#669900"><span 
class="ectt-1200">f9685cb30f234b</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13004r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">instance_type</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">t2</span></span><span style="color:#669900"><span 
class="ectt-1200">.</span></span><span style="color:#669900"><span 
class="ectt-1200">micro</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13005r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">key_name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">vockey</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13006r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">user_data</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span 
class="colorbox" id="colorbox2"><span 
class="ectt-1200">base64encode</span></span><span style="color:#000000"><span 
class="ectt-1200">(&#x003C;&#x003C;-</span></span><span style="color:#000000"><span 
class="ectt-1200">EOT</span></span> 
<span class="label"><a 
 id="x1-13007r7"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#33997E"><span 
class="ectt-1200">#</span></span><span style="color:#33997E"><span 
class="ectt-1200">!/</span></span><span style="color:#33997E"><span 
class="ectt-1200">bin</span></span><span style="color:#33997E"><span 
class="ectt-1200">/</span></span><span style="color:#33997E"><span 
class="ectt-1200">bash</span></span> 
<span class="label"><a 
 id="x1-13008r8"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">yum</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">update</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-</span></span><span style="color:#000000"><span 
class="ectt-1200">y</span></span> 
<span class="label"><a 
 id="x1-13009r9"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">yum</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">install</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-</span></span><span style="color:#000000"><span 
class="ectt-1200">y</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">docker</span></span> 
<span class="label"><a 
 id="x1-13010r10"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">service</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">docker</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">start</span></span> 
<span class="label"><a 
 id="x1-13011r11"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">systemctl</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">enable</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">docker</span></span> 
<span class="label"><a 
 id="x1-13012r12"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">usermod</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-</span></span><span style="color:#000000"><span 
class="ectt-1200">a</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-</span></span><span style="color:#000000"><span 
class="ectt-1200">G</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">docker</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">ec2</span></span><span style="color:#000000"><span 
class="ectt-1200">-</span></span><span style="color:#000000"><span 
class="ectt-1200">user</span></span> 
<span class="label"><a 
 id="x1-13013r13"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">docker</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">run</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">--</span></span><span style="color:#000000"><span 
class="ectt-1200">restart</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">always</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-</span></span><span style="color:#000000"><span 
class="ectt-1200">e</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">SQLALCHEMY_DATABASE_URI</span></span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"><span 
class="ectt-1200">postgresql</span></span><span style="color:#000000"><span 
class="ectt-1200">://</span></span><span style="color:#000000"><span 
class="ectt-1200">$</span></span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"><span 
class="ectt-1200">local</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">database_username</span></span><span style="color:#000000"><span 
class="ectt-1200">}:</span></span><span style="color:#000000"><span 
class="ectt-1200">$</span></span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"><span 
class="ectt-1200">local</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">database_password</span></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span><span style="color:#000000"><span 
class="ectt-1200">@$</span></span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_db_instance</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">database</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">address</span></span><span style="color:#000000"><span 
class="ectt-1200">}:5432/</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-</span></span><span style="color:#000000"><span 
class="ectt-1200">p</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">6400:6400</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">$</span></span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"><span 
class="ectt-1200">local</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">image</span></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13014r14"></a></span><span style="color:#000000"><span 
class="ectt-1200">EOT</span></span> 
<span class="label"><a 
 id="x1-13015r15"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">)</span></span> 
<span class="label"><a 
 id="x1-13016r16"></a></span> 
<span class="label"><a 
 id="x1-13017r17"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">vpc_security_group_ids</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">id</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13018r18"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13019r19"></a></span> 
<span class="label"><a 
 id="x1-13020r20"></a></span> 
<span class="label"><a 
 id="x1-13021r21"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13022r22"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13023r23"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">description</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">TaskOverflow</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Security</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13024r24"></a></span> 
<span class="label"><a 
 id="x1-13025r25"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">ingress</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13026r26"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">6400</span></span> 
<span class="label"><a 
 id="x1-13027r27"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">6400</span></span> 
<span class="label"><a 
 id="x1-13028r28"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">tcp</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13029r29"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cidr_blocks</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">0.0.0.0/0</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13030r30"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13031r31"></a></span> 
<span class="label"><a 
 id="x1-13032r32"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">ingress</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13033r33"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">22</span></span> 
<span class="label"><a 
 id="x1-13034r34"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">22</span></span> 
<span class="label"><a 
 id="x1-13035r35"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">tcp</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13036r36"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cidr_blocks</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">0.0.0.0/0</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13037r37"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13038r38"></a></span> 
<span class="label"><a 
 id="x1-13039r39"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">egress</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13040r40"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0</span></span> 
<span class="label"><a 
 id="x1-13041r41"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0</span></span> 
<span class="label"><a 
 id="x1-13042r42"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">-1</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13043r43"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cidr_blocks</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">0.0.0.0/0</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13044r44"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13045r45"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-13046r46"></a></span></pre>
   </div>
<!--l. 245--><p class="indent" >   Now that we have an instance template and a security group, we can create the AutoScaling Group. The
AutoScaling group is given the instance template and uses it to create groups of instances. The group defines the
desired capacity and the limits of how many instances we want.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 250--><p class="noindent" >
</p><!--l. 251--><p class="noindent" ><img 
src="diagrams/lb1.png" alt="PIC"  
width="14" height="14"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 255--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 255--><p class="indent" >   <span 
class="ectt-1200">» cat autoscaling.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 255--><pre class="listings" id="listing-2"><span class="label"><a 
 id="x1-13047r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_autoscaling_group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13048r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13049r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">availability_zones</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">us</span></span><span style="color:#669900"><span 
class="ectt-1200">-</span></span><span style="color:#669900"><span 
class="ectt-1200">east</span></span><span style="color:#669900"><span 
class="ectt-1200">-1</span></span><span style="color:#669900"><span 
class="ectt-1200">a</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13050r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">desired_capacity</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">1</span></span> 
<span class="label"><a 
 id="x1-13051r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">max_size</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">4</span></span> 
<span class="label"><a 
 id="x1-13052r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">min_size</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">1</span></span> 
<span class="label"><a 
 id="x1-13053r7"></a></span> 
<span class="label"><a 
 id="x1-13054r8"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">launch_template</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13055r9"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">id</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_launch_template</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">id</span></span> 
<span class="label"><a 
 id="x1-13056r10"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">version</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">$Latest</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13057r11"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13058r12"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-13059r13"></a></span></pre>
   </div>
<!--l. 270--><p class="indent" >   If we deployed this now, we would get one initial instance created for us, based on the <span 
class="ectt-1200">desired_capacity </span>and
<span 
class="ectt-1200">min_size </span>values. Now that we have instances we have the ability for traffic to be routed to them. Let&#8217;s create a
target group which will be on the internal facing side of our load balancer. This is the side that lets traffic from the
load balancer hit the instances.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 277--><p class="noindent" >
</p><!--l. 278--><p class="noindent" ><img 
src="diagrams/lb2.png" alt="PIC"  
width="14" height="14"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 282--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 282--><p class="indent" >   <span 
class="ectt-1200">» cat lb.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 282--><pre class="listings" id="listing-3"><span class="label"><a 
 id="x1-13060r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_lb_target_group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13061r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13062r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">6400</span></span> 
<span class="label"><a 
 id="x1-13063r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">HTTP</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13064r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">vpc_id</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">vpc_id</span></span> 
<span class="label"><a 
 id="x1-13065r6"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-13066r7"></a></span></pre>
   </div>
<!--l. 291--><p class="indent" >   We also need to link the <span 
class="ectt-1200">target_group </span>to the autoscaling group.
</p><!--l. 293--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 293--><p class="indent" >   <span 
class="ectt-1200">» cat lb.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 293--><pre class="listings" id="listing-4"><span class="label"><a 
 id="x1-13067r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_autoscaling_attachment</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13068r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">autoscaling_group_name</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_autoscaling_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">id</span></span> 
<span class="label"><a 
 id="x1-13069r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">alb_target_group_arn</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_lb_target_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span> 
<span class="label"><a 
 id="x1-13070r4"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-13071r5"></a></span></pre>
   </div>
<!--l. 300--><p class="indent" >   We now need to create a load balancer and route traffic to our target group. You will notice that there is also a
security group attached to the load balancer. This is the firewall that sits on the front of the load balancer and
allows traffic to enter the load balancer.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 305--><p class="noindent" >
</p><!--l. 306--><p class="noindent" ><img 
src="diagrams/lb3.png" alt="PIC"  
width="14" height="14"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 310--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 310--><p class="indent" >   <span 
class="ectt-1200">» cat lb.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 310--><pre class="listings" id="listing-5"><span class="label"><a 
 id="x1-13072r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_lb</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13073r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13074r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">internal</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">false</span></span> 
<span class="label"><a 
 id="x1-13075r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">load_balancer_type</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">application</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13076r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">subnets</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#006699"><span 
class="ectt-1200">data</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_subnets</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">private</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">ids</span></span> 
<span class="label"><a 
 id="x1-13077r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">security_groups</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">id</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13078r7"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13079r8"></a></span> 
<span class="label"><a 
 id="x1-13080r9"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13081r10"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13082r11"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">description</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">TaskOverflow</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Security</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13083r12"></a></span> 
<span class="label"><a 
 id="x1-13084r13"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">ingress</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13085r14"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">80</span></span> 
<span class="label"><a 
 id="x1-13086r15"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">80</span></span> 
<span class="label"><a 
 id="x1-13087r16"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">tcp</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13088r17"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cidr_blocks</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">0.0.0.0/0</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13089r18"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13090r19"></a></span> 
<span class="label"><a 
 id="x1-13091r20"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">egress</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13092r21"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0</span></span> 
<span class="label"><a 
 id="x1-13093r22"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0</span></span> 
<span class="label"><a 
 id="x1-13094r23"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">-1</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13095r24"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cidr_blocks</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">0.0.0.0/0</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13096r25"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13097r26"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-13098r27"></a></span></pre>
   </div>
<!--l. 339--><p class="indent" >   The load balancer now needs a way to accept incoming traffic. We need a listener which creates the rules for
how traffic is routed to the instances.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 343--><p class="noindent" >
</p><!--l. 344--><p class="noindent" ><img 
src="diagrams/lb4.png" alt="PIC"  
width="14" height="14"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 348--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 348--><p class="indent" >   <span 
class="ectt-1200">» cat lb.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 348--><pre class="listings" id="listing-6"><span class="label"><a 
 id="x1-13099r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_lb_listener</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13100r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">load_balancer_arn</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_lb</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span> 
<span class="label"><a 
 id="x1-13101r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">80</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13102r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">HTTP</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13103r5"></a></span> 
<span class="label"><a 
 id="x1-13104r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">default_action</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13105r7"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">type</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">forward</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13106r8"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target_group_arn</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_lb_target_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span> 
<span class="label"><a 
 id="x1-13107r9"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13108r10"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-13109r11"></a></span></pre>
   </div>
<!--l. 361--><p class="indent" >   Now we are able to deploy our infrastructure.  </p><div class="framedenv" id="shaded*-1">
   <!--l. 362-->
<pre class="lstlisting" id="listing-7"><span class="label"><a 
 id="x1-13110r1"></a></span><span style="color:#000000"><span 
class="ectt-1200">$</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">terraform</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">apply</span></span><span 
class="ectt-1200">&#x00A0;</span></pre>
   </div> We have created the architecture as requested with a dynamically scaling group of EC2s and
an Application Load Balancer in front which is listens on port 80 and routes to port 6400 of the
instances.
<!--l. 365--><p class="indent" >   To make our autoscaling group perform dynamic scaling, we need to create some rules for when to scale up
and when to scale down. The policies below track the average CPU usage of the group of instances. If the usage is
above 20 percent it will scale up by 1 instance, and if it is below 10 percent it will scale down by 1 instance. We also
apply a cooldown period so that we do not act too aggressivly to changes in CPU usage, as instances will take time
to start and handle load.
</p><!--l. 373--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 373--><p class="indent" >   <span 
class="ectt-1200">» cat autoscaling.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 373--><pre class="listings" id="listing-8"><span class="label"><a 
 id="x1-13111r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_autoscaling_policy</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_down</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13112r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_down</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13113r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">autoscaling_group_name</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_autoscaling_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">name</span></span> 
<span class="label"><a 
 id="x1-13114r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">adjustment_type</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">ChangeInCapacity</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13115r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">scaling_adjustment</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-1</span></span> 
<span class="label"><a 
 id="x1-13116r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cooldown</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">120</span></span> 
<span class="label"><a 
 id="x1-13117r7"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13118r8"></a></span> 
<span class="label"><a 
 id="x1-13119r9"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_cloudwatch_metric_alarm</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_down</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13120r10"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">alarm_description</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">Monitors</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">CPU</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">utilization</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">for</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13121r11"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">alarm_actions</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_autoscaling_policy</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo_scale_down</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13122r12"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">alarm_name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_down</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13123r13"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">comparison_operator</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">LessThanOrEqualToThreshold</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13124r14"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">namespace</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">AWS</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">EC2</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13125r15"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">metric_name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">CPUUtilization</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13126r16"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">threshold</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">10</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13127r17"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">evaluation_periods</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">2</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13128r18"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">period</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">120</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13129r19"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">statistic</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">Average</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13130r20"></a></span> 
<span class="label"><a 
 id="x1-13131r21"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">dimensions</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13132r22"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">AutoScalingGroupName</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_autoscaling_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">name</span></span> 
<span class="label"><a 
 id="x1-13133r23"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13134r24"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13135r25"></a></span> 
<span class="label"><a 
 id="x1-13136r26"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_autoscaling_policy</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_up</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13137r27"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_up</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13138r28"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">autoscaling_group_name</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_autoscaling_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">name</span></span> 
<span class="label"><a 
 id="x1-13139r29"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">adjustment_type</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">ChangeInCapacity</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13140r30"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">scaling_adjustment</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">1</span></span> 
<span class="label"><a 
 id="x1-13141r31"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cooldown</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">120</span></span> 
<span class="label"><a 
 id="x1-13142r32"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13143r33"></a></span> 
<span class="label"><a 
 id="x1-13144r34"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_cloudwatch_metric_alarm</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_up</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13145r35"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">alarm_description</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">Monitors</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">CPU</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">utilization</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">for</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13146r36"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">alarm_actions</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_autoscaling_policy</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo_scale_up</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-13147r37"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">alarm_name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo_scale_up</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13148r38"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">comparison_operator</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">GreaterThanThreshold</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13149r39"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">namespace</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">AWS</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">EC2</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13150r40"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">metric_name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">CPUUtilization</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13151r41"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">threshold</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">20</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13152r42"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">evaluation_periods</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">2</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13153r43"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">period</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">120</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13154r44"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">statistic</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">Average</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-13155r45"></a></span> 
<span class="label"><a 
 id="x1-13156r46"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">dimensions</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-13157r47"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">AutoScalingGroupName</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_autoscaling_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">name</span></span> 
<span class="label"><a 
 id="x1-13158r48"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-13159r49"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-13160r50"></a></span></pre>
   </div>
<!--l. 425--><p class="indent" >   Head to Section <a 
href="#x1-150004.3">4.3<!--tex4ht:ref: k6 --></a> to see how we can send multiple requests to our service so that the load balancer has to
scale up.
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.2    </span> <a 
 id="x1-140004.2"></a>[Path B] ECS</h4>
<!--l. 429--><p class="noindent" >Congratulations! You have chosen to go down the ECS path. This week we need create an Application Scaling
Policy for our ECS service and a Load Balancer to handle the routing of our service. Our goal is to implement the
deployment diagram below.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<!--l. 435--><p class="noindent" ><img 
src="diagrams/ecsdeployment.png" alt="PIC"  
width="525" height="525"  />
                                                                                                    
                                                                                                    
</p>
   </div><hr class="endfigure" />
<!--l. 438--><p class="indent" >   Last week, when we setup the ECS service, we noticed that we could not get an endpoint because the instance
would only be provisioned after our Terraform code had run. This is because ECS is already a dynamic scaling
service and it expects a load balancer to route its traffic. To get started we need to create a target group which
defines where traffic can be routed to.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 443--><p class="noindent" >
</p><!--l. 444--><p class="noindent" ><img 
src="diagrams/lb2fargate.png" alt="PIC"  
width="14" height="14"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 448--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 448--><p class="indent" >   <span 
class="ectt-1200">» cat lb.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 448--><pre class="listings" id="listing-9"><span class="label"><a 
 id="x1-14001r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_lb_target_group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14002r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14003r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">6400</span></span> 
<span class="label"><a 
 id="x1-14004r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">HTTP</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14005r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">vpc_id</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">vpc_id</span></span> 
<span class="label"><a 
 id="x1-14006r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target_type</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">ip</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14007r7"></a></span> 
<span class="label"><a 
 id="x1-14008r8"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">health_check</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14009r9"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">path</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">api</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">v1</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">health</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14010r10"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">6400</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14011r11"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">HTTP</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14012r12"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">healthy_threshold</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">2</span></span> 
<span class="label"><a 
 id="x1-14013r13"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">unhealthy_threshold</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">2</span></span> 
<span class="label"><a 
 id="x1-14014r14"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">timeout</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">5</span></span> 
<span class="label"><a 
 id="x1-14015r15"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">interval</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">10</span></span> 
<span class="label"><a 
 id="x1-14016r16"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14017r17"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-14018r18"></a></span></pre>
   </div>
<!--l. 468--><p class="indent" >   Load balancing is core to how ECS works and so the <span 
class="ectt-1200">aws_ecs_service </span>resource that we used last week
accepts a <span 
class="ectt-1200">load_balancer </span>block. To associate the target group with our ECS service, modify the given
<span 
class="ectt-1200">aws_ecs_service.taskoverflow </span>resource to include a <span 
class="ectt-1200">load_balancer </span>block.
</p><!--l. 472--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 472--><p class="indent" >   <span 
class="ectt-1200">» cat ecs.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 472--><pre class="listings" id="listing-10"><span class="label"><a 
 id="x1-14019r1"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">load_balancer</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14020r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target_group_arn</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_lb_target_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span> 
<span class="label"><a 
 id="x1-14021r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">container_name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14022r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">container_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">6400</span></span> 
<span class="label"><a 
 id="x1-14023r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-14024r6"></a></span></pre>
   </div>
<!--l. 480--><p class="indent" >   With the internal side of the load balancer done, we can create it and a firewall for the external side. This
firewall allows us to restrict what traffic will be allowed to reach the load balancer.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 484--><p class="noindent" >
</p><!--l. 485--><p class="noindent" ><img 
src="diagrams/lb3fargate.png" alt="PIC"  
width="14" height="14"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 489--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 489--><p class="indent" >   <span 
class="ectt-1200">» cat lb.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 489--><pre class="listings" id="listing-11"><span class="label"><a 
 id="x1-14025r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_lb</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14026r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14027r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">internal</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">false</span></span> 
<span class="label"><a 
 id="x1-14028r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">load_balancer_type</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">application</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14029r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">subnets</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#006699"><span 
class="ectt-1200">data</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_subnets</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">private</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">ids</span></span> 
<span class="label"><a 
 id="x1-14030r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">security_groups</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#000000"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">id</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-14031r7"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14032r8"></a></span> 
<span class="label"><a 
 id="x1-14033r9"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_security_group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14034r10"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14035r11"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">description</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">TaskOverflow</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Security</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">Group</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14036r12"></a></span> 
<span class="label"><a 
 id="x1-14037r13"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">ingress</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14038r14"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">80</span></span> 
<span class="label"><a 
 id="x1-14039r15"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">80</span></span> 
<span class="label"><a 
 id="x1-14040r16"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">tcp</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14041r17"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cidr_blocks</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">0.0.0.0/0</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-14042r18"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14043r19"></a></span> 
<span class="label"><a 
 id="x1-14044r20"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">egress</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14045r21"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0</span></span> 
<span class="label"><a 
 id="x1-14046r22"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to_port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0</span></span> 
<span class="label"><a 
 id="x1-14047r23"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">-1</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14048r24"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">cidr_blocks</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">0.0.0.0/0</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"><span 
class="ectt-1200">]</span></span> 
<span class="label"><a 
 id="x1-14049r25"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14050r26"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-14051r27"></a></span></pre>
   </div>
<!--l. 518--><p class="indent" >   Now over to the external side of the load balancer. We need to create a listener which is the entry point for the
load balancer.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 522--><p class="noindent" >
</p><!--l. 523--><p class="noindent" ><img 
src="diagrams/lb4fargate.png" alt="PIC"  
width="14" height="14"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 527--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 527--><p class="indent" >   <span 
class="ectt-1200">» cat lb.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 527--><pre class="listings" id="listing-12"><span class="label"><a 
 id="x1-14052r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_lb_listener</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14053r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">load_balancer_arn</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_lb</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span> 
<span class="label"><a 
 id="x1-14054r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">port</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">80</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14055r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">protocol</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">HTTP</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14056r5"></a></span> 
<span class="label"><a 
 id="x1-14057r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">default_action</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14058r7"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">type</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">forward</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14059r8"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target_group_arn</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_lb_target_group</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">arn</span></span> 
<span class="label"><a 
 id="x1-14060r9"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14061r10"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-14062r11"></a></span></pre>
   </div>
<!--l. 540--><p class="indent" >   If we deployed now, we would have implemented the deployment diagram above. However, we want to add
autoscaling to our service so that it can scale up and down based on the load.
</p><!--l. 543--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 543--><p class="indent" >   <span 
class="ectt-1200">» cat autoscaling.tf</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 543--><pre class="listings" id="listing-13"><span class="label"><a 
 id="x1-14063r1"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_appautoscaling_target</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14064r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">max_capacity</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">4</span></span> 
<span class="label"><a 
 id="x1-14065r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">min_capacity</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">1</span></span> 
<span class="label"><a 
 id="x1-14066r4"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">resource_id</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">service</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">taskoverflow</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14067r5"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">scalable_dimension</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">ecs</span></span><span style="color:#669900"><span 
class="ectt-1200">:</span></span><span style="color:#669900"><span 
class="ectt-1200">service</span></span><span style="color:#669900"><span 
class="ectt-1200">:</span></span><span style="color:#669900"><span 
class="ectt-1200">DesiredCount</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14068r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">service_namespace</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">ecs</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14069r7"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14070r8"></a></span> 
<span class="label"><a 
 id="x1-14071r9"></a></span> 
<span class="label"><a 
 id="x1-14072r10"></a></span><span style="color:#006699"><span 
class="ectt-1200">resource</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">aws_appautoscaling_policy</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">-</span></span><span style="color:#669900"><span 
class="ectt-1200">cpu</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14073r11"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">name</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">todo</span></span><span style="color:#669900"><span 
class="ectt-1200">-</span></span><span style="color:#669900"><span 
class="ectt-1200">cpu</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14074r12"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">policy_type</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">TargetTrackingScaling</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14075r13"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">resource_id</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_appautoscaling_target</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">resource_id</span></span> 
<span class="label"><a 
 id="x1-14076r14"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">scalable_dimension</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_appautoscaling_target</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">scalable_dimension</span></span> 
<span class="label"><a 
 id="x1-14077r15"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">service_namespace</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">aws_appautoscaling_target</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">todo</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">service_namespace</span></span> 
<span class="label"><a 
 id="x1-14078r16"></a></span> 
<span class="label"><a 
 id="x1-14079r17"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target_tracking_scaling_policy_configuration</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14080r18"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">predefined_metric_specification</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-14081r19"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">predefined_metric_type</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="ectt-1200">"</span></span><span style="color:#669900"><span 
class="ectt-1200">ECSServiceAverageCPUUtilization</span></span><span style="color:#669900"><span 
class="ectt-1200">"</span></span> 
<span class="label"><a 
 id="x1-14082r20"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14083r21"></a></span> 
<span class="label"><a 
 id="x1-14084r22"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target_value</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">20</span></span> 
<span class="label"><a 
 id="x1-14085r23"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span> 
<span class="label"><a 
 id="x1-14086r24"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-14087r25"></a></span></pre>
   </div>
<!--l. 570--><p class="indent" >   This auto scaling policy looks at the average CPU utilization of the service and scales up if it is above 20% and
scales down if it is below 20%. This is a very simple policy but it is a good starting point. We can now deploy our
service and see it scale up and down.
</p><!--l. 574--><p class="indent" >   Continue onto the next section to see how to send multiple requests to our service to generate traffic to
trigger scaling.
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.3    </span> <a 
 id="x1-150004.3"></a>Producing Load with k6</h4>
<!--l. 578--><p class="noindent" >We have a service but us visiting it in our web browser is not going to be enough load for our scaling policies to
trigger. To do this we will employ the help of a tool called k6, which is a relatively new load testing tool. To install
k6 visit <a 
href="https://k6.io/docs/get-started/installation/" class="url" ><span 
class="ectt-1200">https://k6.io/docs/get-started/installation/</span></a>. It can be installed in the code spaces
environment or locally.
</p><!--l. 584--><p class="indent" >   We have provided an example k6 file, which is JavaScript code that creates 1000 to 5000 users to call the list
endpoint of our service.
</p><!--l. 587--><p class="indent" >   </p><div class="framedenv" id="code-1">
<!--l. 587--><p class="indent" >   <span 
class="ectt-1200">» cat k6.js</span> </p></div>   <div class="framedenv" id="code-1"><!--l. 587--><pre class="listings" id="listing-14"><span class="label"><a 
 id="x1-15001r1"></a></span><span style="color:#404040"><span 
class="ectt-1200">import</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">http</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#669900"><span 
class="ectt-1200">k6</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">http</span></span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#000000"><span 
class="ectt-1200">;</span></span> 
<span class="label"><a 
 id="x1-15002r2"></a></span><span style="color:#404040"><span 
class="ectt-1200">import</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">sleep</span></span><span style="color:#000000"><span 
class="ectt-1200">,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">check</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">}</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">from</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#669900"><span 
class="ectt-1200">k6</span></span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#000000"><span 
class="ectt-1200">;</span></span> 
<span class="label"><a 
 id="x1-15003r3"></a></span> 
<span class="label"><a 
 id="x1-15004r4"></a></span><span style="color:#404040"><span 
class="ectt-1200">export</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">const</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">options</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-15005r5"></a></span><span 
class="ectt-1200">&#x00A0;</span><span style="color:#000000"><span 
class="ectt-1200">stages</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[</span></span> 
<span class="label"><a 
 id="x1-15006r6"></a></span><span 
class="ectt-1200">&#x00A0;</span><span 
class="ectt-1200">&#x00A0;</span><span 
class="ectt-1200">&#x00A0;</span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">1000,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">duration</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#669900"><span 
class="ectt-1200">1</span></span><span style="color:#669900"><span 
class="ectt-1200">m</span></span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">},</span></span> 
<span class="label"><a 
 id="x1-15007r7"></a></span><span 
class="ectt-1200">&#x00A0;</span><span 
class="ectt-1200">&#x00A0;</span><span 
class="ectt-1200">&#x00A0;</span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">target</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">5000,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">duration</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#669900"><span 
class="ectt-1200">10</span></span><span style="color:#669900"><span 
class="ectt-1200">m</span></span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">},</span></span> 
<span class="label"><a 
 id="x1-15008r8"></a></span><span 
class="ectt-1200">&#x00A0;</span><span style="color:#000000"><span 
class="ectt-1200">],</span></span> 
<span class="label"><a 
 id="x1-15009r9"></a></span><span style="color:#000000"><span 
class="ectt-1200">};</span></span> 
<span class="label"><a 
 id="x1-15010r10"></a></span> 
<span class="label"><a 
 id="x1-15011r11"></a></span><span style="color:#404040"><span 
class="ectt-1200">export</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">default</span></span><span style="color:#000000"> </span><span style="color:#006699"><span 
class="ectt-1200">function</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">()</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span> 
<span class="label"><a 
 id="x1-15012r12"></a></span><span 
class="ectt-1200">&#x00A0;</span><span style="color:#000000"><span 
class="ectt-1200">const</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">res</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">http</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">get</span></span><span style="color:#000000"><span 
class="ectt-1200">(</span></span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#669900"><span 
class="ectt-1200">http</span></span><span style="color:#669900"><span 
class="ectt-1200">://</span></span><span 
class="colorbox" id="colorbox3"><span 
class="ectt-1200">your-loadBalancer-url-here</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">api</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">v1</span></span><span style="color:#669900"><span 
class="ectt-1200">/</span></span><span style="color:#669900"><span 
class="ectt-1200">todos</span></span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#000000"><span 
class="ectt-1200">)</span></span><span style="color:#000000"><span 
class="ectt-1200">;</span></span> 
<span class="label"><a 
 id="x1-15013r13"></a></span><span 
class="ectt-1200">&#x00A0;</span><span style="color:#000000"><span 
class="ectt-1200">check</span></span><span style="color:#000000"><span 
class="ectt-1200">(</span></span><span style="color:#000000"><span 
class="ectt-1200">res</span></span><span style="color:#000000"><span 
class="ectt-1200">,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">{</span></span><span style="color:#000000"> </span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#669900"><span 
class="ectt-1200">status</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">was</span></span><span style="color:#669900"> </span><span style="color:#669900"><span 
class="ectt-1200">200</span></span><span style="color:#669900"><span 
class="tctt-1200">'</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">(</span></span><span style="color:#000000"><span 
class="ectt-1200">r</span></span><span style="color:#000000"><span 
class="ectt-1200">)</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">=&#x003E;</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">r</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">status</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">==</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">200</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">})</span></span><span style="color:#000000"><span 
class="ectt-1200">;</span></span> 
<span class="label"><a 
 id="x1-15014r14"></a></span><span 
class="ectt-1200">&#x00A0;</span><span style="color:#000000"><span 
class="ectt-1200">sleep</span></span><span style="color:#000000"><span 
class="ectt-1200">(1)</span></span><span style="color:#000000"><span 
class="ectt-1200">;</span></span> 
<span class="label"><a 
 id="x1-15015r15"></a></span><span style="color:#000000"><span 
class="ectt-1200">}</span></span>
 
<span class="label"><a 
 id="x1-15016r16"></a></span></pre>
   </div>
<!--l. 605--><p class="indent" >   We can then run this file using the following command.
</p>
   <div class="framedenv" id="shaded*-1">
   <!--l. 607-->
<pre class="lstlisting" id="listing-15"><span class="label"><a 
 id="x1-15017r1"></a></span><span style="color:#000000"><span 
class="ectt-1200">$</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">k6</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">run</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">k6</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">js</span></span><span 
class="ectt-1200">&#x00A0;</span></pre>
   </div>
   <div class="framedenv" id="code-1">
<!--l. 609--><pre class="listings" id="listing-16"><span class="label"><a 
 id="x1-15018r1"></a></span><span style="color:#000000"><span 
class="ectt-1200">execution</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#006699"><span 
class="ectt-1200">local</span></span> 
<span class="label"><a 
 id="x1-15019r2"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">script</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">load</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"><span 
class="ectt-1200">js</span></span> 
<span class="label"><a 
 id="x1-15020r3"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">output</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">-</span></span> 
<span class="label"><a 
 id="x1-15021r4"></a></span> 
<span class="label"><a 
 id="x1-15022r5"></a></span><span style="color:#000000"><span 
class="ectt-1200">scenarios</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">(100.00%)</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">1</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">scenario</span></span><span style="color:#000000"><span 
class="ectt-1200">,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">5000</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">max</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">VUs</span></span><span style="color:#000000"><span 
class="ectt-1200">,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">11</span></span><span style="color:#000000"><span 
class="ectt-1200">m30s</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">max</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">duration</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">(</span></span><span style="color:#000000"><span 
class="ectt-1200">incl</span></span><span style="color:#000000"><span 
class="ectt-1200">.</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">graceful</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">stop</span></span><span style="color:#000000"><span 
class="ectt-1200">)</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span> 
<span class="label"><a 
 id="x1-15023r6"></a></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">*</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">default</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">Up</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">to</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">5000</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">looping</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">VUs</span></span><span style="color:#000000"> </span><span style="color:#006699"><span 
class="ectt-1200">for</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">11</span></span><span style="color:#000000"><span 
class="ectt-1200">m0s</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">over</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">2</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">stages</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">(</span></span><span style="color:#000000"><span 
class="ectt-1200">gracefulRampDown</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">30</span></span><span style="color:#000000"><span 
class="ectt-1200">s</span></span><span style="color:#000000"><span 
class="ectt-1200">,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">gracefulStop</span></span><span style="color:#000000"><span 
class="ectt-1200">:</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">30</span></span><span style="color:#000000"><span 
class="ectt-1200">s</span></span><span style="color:#000000"><span 
class="ectt-1200">)</span></span> 
<span class="label"><a 
 id="x1-15024r7"></a></span> 
<span class="label"><a 
 id="x1-15025r8"></a></span> 
<span class="label"><a 
 id="x1-15026r9"></a></span><span style="color:#000000"><span 
class="ectt-1200">running</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">(00</span></span><span style="color:#000000"><span 
class="ectt-1200">m05</span></span><span style="color:#000000"><span 
class="ectt-1200">.4</span></span><span style="color:#000000"><span 
class="ectt-1200">s</span></span><span style="color:#000000"><span 
class="ectt-1200">)</span></span><span style="color:#000000"><span 
class="ectt-1200">,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0091/5000</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">VUs</span></span><span style="color:#000000"><span 
class="ectt-1200">,</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">140</span></span><span style="color:#000000"> </span><span style="color:#006699"><span 
class="ectt-1200">complete</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">and</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">interrupted</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">iterations</span></span> 
<span class="label"><a 
 id="x1-15027r10"></a></span><span style="color:#000000"><span 
class="ectt-1200">default</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">[--------------------------------------]</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">0091/5000</span></span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">VUs</span></span><span style="color:#000000"> </span><span style="color:#000000"> </span><span style="color:#000000"><span 
class="ectt-1200">00</span></span><span style="color:#000000"><span 
class="ectt-1200">m05</span></span><span style="color:#000000"><span 
class="ectt-1200">.4</span></span><span style="color:#000000"><span 
class="ectt-1200">s</span></span><span style="color:#000000"><span 
class="ectt-1200">/11</span></span><span style="color:#000000"><span 
class="ectt-1200">m00</span></span><span style="color:#000000"><span 
class="ectt-1200">.0</span></span><span style="color:#000000"><span 
class="ectt-1200">s</span></span>
 
<span class="label"><a 
 id="x1-15030r13"></a></span></pre>
   </div>
<!--l. 623--><p class="noindent" >
</p>
   <h5 class="subsubsectionHead"><span class="titlemark">4.3.1    </span> <a 
 id="x1-160004.3.1"></a>EC2 Auto Scaling</h5>
<!--l. 625--><p class="noindent" >With all the pieces together we can now see if our efforts have paid off. While the above k6 code is running, let&#8217;s
check the EC2 console and see what actions our autoscaling policy has taken. In the EC2 console scroll down the
left hand menu and select <span 
class="ectt-1200">Auto Scaling Groups</span>.
                                                                                                    
                                                                                                    
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 630--><p class="noindent" >
</p><!--l. 631--><p class="noindent" ><img 
src="images/ec2_1.png" alt="PIC"  
width="36" height="36"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 635--><p class="indent" >   You will be presented with our todo group, which states the current instances and the desired minimum and
maximum number of instances. Select the name of the group.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 639--><p class="noindent" >
</p><!--l. 640--><p class="noindent" ><img 
src="images/ec2_3.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 644--><p class="indent" >   In this panel we are presented with much of the same information, but what we want is the <span 
class="ectt-1200">Automatic</span>
<span 
class="ectt-1200">scaling </span>tab.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 647--><p class="noindent" >
</p><!--l. 648--><p class="noindent" ><img 
src="images/ec2_4.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 652--><p class="indent" >   In this tab our two policies are displayed and we can see the configuration of both.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 655--><p class="noindent" >
</p><!--l. 656--><p class="noindent" ><img 
src="images/ec2_5.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 660--><p class="indent" >   In the <span 
class="ectt-1200">Activity </span>tab we can see the actions performed by our policies, whether it be a scale up or a scale
down.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 663--><p class="noindent" >
</p><!--l. 664--><p class="noindent" ><img 
src="images/ec2_6.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 668--><p class="indent" >   If we head over to CloudWatch alarms, we can see the alarms that are the triggers for our policies.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 671--><p class="noindent" >
</p><!--l. 672--><p class="noindent" ><img 
src="images/ec2_7.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
   <h5 class="subsubsectionHead"><span class="titlemark">4.3.2    </span> <a 
 id="x1-170004.3.2"></a>ECS Auto Scaling</h5>
<!--l. 678--><p class="noindent" >With all the pieces together we can now see if our efforts have paid off. While the k6 code from above is running,
let&#8217;s go to the ECS console and see if we can see any scaling events. Navigate to <span 
class="ectt-1200">ECS </span>-&#x003E; <span 
class="ectt-1200">Clusters </span>-&#x003E;
<span 
class="ectt-1200">taskoverflow </span>-&#x003E; <span 
class="ectt-1200">Services </span>-&#x003E; <span 
class="ectt-1200">taskoverflow </span>-&#x003E; <span 
class="ectt-1200">Configuration and tasks</span>.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 683--><p class="noindent" >
</p><!--l. 684--><p class="noindent" ><img 
src="images/ecs1.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 688--><p class="indent" >   In this panel we can see our Auto Scaling configuration which lists the desired, minimum and maximum
number of tasks. The policies are listed further down and we can view the alarm which is a graphical
representation of the CPU utilization vs the target value.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 691--><p class="noindent" >
</p><!--l. 692--><p class="noindent" ><img 
src="images/ecs2.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
<!--l. 696--><p class="indent" >   In the Cloudwatch Alarm panel you will notice that we have two different alarms, these are for the
scaling up and down of the service. Selecting the alarm you can view the status where an "in alert"
alarm is when the auto scaling configuration needs to action increasing/decreasing the number of
instances.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
<div class="center" 
>
<!--l. 701--><p class="noindent" >
</p><!--l. 702--><p class="noindent" ><img 
src="images/ecs3.png" alt="PIC"  
width="525" height="525"  /></p></div>
                                                                                                    
                                                                                                    
   </div><hr class="endfigure" />
   <h3 class="sectionHead"><span class="titlemark">5    </span> <a 
 id="x1-180005"></a>Conclusion</h3>
<!--l. 708--><p class="noindent" >You have now deployed an scalable stateless service. If you would like to experiment with generating different
load for the service, please read through the k6 documentation at <a 
href="https://k6.io/docs/" class="url" ><span 
class="ectt-1200">https://k6.io/docs/</span></a>.
</p><!--l. 712--><p class="indent" >   In the cloud assignment, we will use <span 
class="ectt-1200">k6 </span>to test various scenarios as described in the task sheet and
evaluate how your service performs. It will be beneficial to be familiar with how this type of testing
works.
</p><!--l. 1--><p class="noindent" >
</p>
   <h3 class="likesectionHead"><a 
 id="x1-19000"></a>References</h3>
<!--l. 1--><p class="noindent" >
   </p><div class="thebibliography">
   <p class="bibitem" ><span class="biblabel">
 [1]<span class="bibsp">&#x00A0;&#x00A0;&#x00A0;</span></span><a 
 id="Xdistributed2-slides"></a>B.&#x00A0;Webb,         &#8220;Distributed         systems         II         slides,&#8221;         March         2023.                                  
<a 
href="https://csse6400.uqcloud.net/slides/distributed2.pdf" class="url" ><span 
class="ectt-1200">https://csse6400.uqcloud.net/slides/distributed2.pdf</span></a>.
</p>
   </div>
   <div class="footnotes"><a 
 id="x1-8002x3.1"></a>
<!--l. 108--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn1x0-bk" id="fn1x0"><sup class="textsuperscript">1</sup></a></span><span 
class="Cabin-Regular-tlf-t1-">OSI layer 7: Application, in this case HTTP/HTTPS/etc</span></p><a 
 id="x1-8004x3.1"></a>
<!--l. 112--><p class="noindent" ><span class="footnote-mark"><a 
href="#fn2x0-bk" id="fn2x0"><sup class="textsuperscript">2</sup></a></span><span 
class="Cabin-Regular-tlf-t1-">OSI layer 4: Transport, in this case TCP/UDP</span></p><a 
 id="x1-9002x3.2"></a>
<!--l. 119--><p class="indent" >        <span class="footnote-mark"><a 
href="#fn3x0-bk" id="fn3x0"><sup class="textsuperscript">3</sup></a></span><span 
class="Cabin-Regular-tlf-t1-">Elastic, in a cloud computing context, refers to the system&#8217;s ability to adapt to workload by starting and stopping infrastructure</span>
<span 
class="Cabin-Regular-tlf-t1-">services to meet demand.</span></p><a 
 id="x1-11002x4"></a>
<!--l. 162--><p class="indent" >        <span class="footnote-mark"><a 
href="#fn4x0-bk" id="fn4x0"><sup class="textsuperscript">4</sup></a></span><span 
class="Cabin-Regular-tlf-t1-">We will not explore scaling persistent data in the practicals. If you wish to try in your assignment, please see some of the</span>
<span 
class="Cabin-Regular-tlf-t1-">concepts presented in the Distributed Systems II lecture </span><span class="cite"><span 
class="Cabin-Regular-tlf-t1-">[</span><a 
href="#Xdistributed2-slides"><span 
class="Cabin-Regular-tlf-t1-">1</span></a><span 
class="Cabin-Regular-tlf-t1-">]</span></span><span 
class="Cabin-Regular-tlf-t1-">.</span></p>                                                                                                                           </div>
 
</body></html> 

                                                                                                    


